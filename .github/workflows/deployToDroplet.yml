name: Deploy NestJS App

on:
    push:
        branches:
            - main # Trigger deployment on push to main branch

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up SSH
              uses: webfactory/ssh-agent@v0.9.0
              with:
                  ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

            - name: Rsync files to Droplet
              run: |
                  rsync -avz --delete \
                    -e "ssh -o StrictHostKeyChecking=no" \
                    ./ ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_IP }}:/var/www/nestjs-app

            - name: Install dependencies on Droplet
              run: |
                  ssh -o StrictHostKeyChecking=no ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_IP }} << 'EOF'
                    export NVM_DIR=~/.nvm
                    source ~/.bashrc
                    cd /var/www/nestjs-app
                    pnpm install
                    pnpm run build
                    pm2 restart ecosystem.config.js || pm2 start ecosystem.config.js
                  EOF
